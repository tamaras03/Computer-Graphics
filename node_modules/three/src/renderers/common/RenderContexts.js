import ChainMap from './ChainMap.js';
import RenderContext from './RenderContext.js';
<<<<<<< HEAD

class RenderContexts {

	constructor() {

=======
import { Scene } from '../../scenes/Scene.js';
import { Camera } from '../../cameras/Camera.js';

const _chainKeys = [];
const _defaultScene = /*@__PURE__*/ new Scene();
const _defaultCamera = /*@__PURE__*/ new Camera();

/**
 * This module manages the render contexts of the renderer.
 *
 * @private
 */
class RenderContexts {

	/**
	 * Constructs a new render context management component.
	 */
	constructor() {

		/**
		 * A dictionary that manages render contexts in chain maps
		 * for each attachment state.
		 *
		 * @type {Object<string,ChainMap>}
		 */
>>>>>>> 50c6784a0819c7177d83555e6a1624cb4553e499
		this.chainMaps = {};

	}

<<<<<<< HEAD
	get( scene, camera, renderTarget = null ) {

		const chainKey = [ scene, camera ];
=======
	/**
	 * Returns a render context for the given scene, camera and render target.
	 *
	 * @param {Scene} scene - The scene.
	 * @param {Camera} camera - The camera that is used to render the scene.
	 * @param {?RenderTarget} [renderTarget=null] - The active render target.
	 * @return {RenderContext} The render context.
	 */
	get( scene, camera, renderTarget = null ) {

		_chainKeys[ 0 ] = scene;
		_chainKeys[ 1 ] = camera;
>>>>>>> 50c6784a0819c7177d83555e6a1624cb4553e499

		let attachmentState;

		if ( renderTarget === null ) {

			attachmentState = 'default';

		} else {

			const format = renderTarget.texture.format;
			const count = renderTarget.textures.length;

			attachmentState = `${ count }:${ format }:${ renderTarget.samples }:${ renderTarget.depthBuffer }:${ renderTarget.stencilBuffer }`;

		}

<<<<<<< HEAD
		const chainMap = this.getChainMap( attachmentState );

		let renderState = chainMap.get( chainKey );
=======
		const chainMap = this._getChainMap( attachmentState );

		let renderState = chainMap.get( _chainKeys );
>>>>>>> 50c6784a0819c7177d83555e6a1624cb4553e499

		if ( renderState === undefined ) {

			renderState = new RenderContext();

<<<<<<< HEAD
			chainMap.set( chainKey, renderState );

		}

=======
			chainMap.set( _chainKeys, renderState );

		}

		_chainKeys.length = 0;

>>>>>>> 50c6784a0819c7177d83555e6a1624cb4553e499
		if ( renderTarget !== null ) renderState.sampleCount = renderTarget.samples === 0 ? 1 : renderTarget.samples;

		return renderState;

	}

<<<<<<< HEAD
	getChainMap( attachmentState ) {
=======
	/**
	 * Returns a render context intended for clear operations.
	 *
	 * @param {?RenderTarget} [renderTarget=null] - The active render target.
	 * @return {RenderContext} The render context.
	 */
	getForClear( renderTarget = null ) {

		return this.get( _defaultScene, _defaultCamera, renderTarget );

	}

	/**
	 * Returns a chain map for the given attachment state.
	 *
	 * @private
	 * @param {string} attachmentState - The attachment state.
	 * @return {ChainMap} The chain map.
	 */
	_getChainMap( attachmentState ) {
>>>>>>> 50c6784a0819c7177d83555e6a1624cb4553e499

		return this.chainMaps[ attachmentState ] || ( this.chainMaps[ attachmentState ] = new ChainMap() );

	}

<<<<<<< HEAD
=======
	/**
	 * Frees internal resources.
	 */
>>>>>>> 50c6784a0819c7177d83555e6a1624cb4553e499
	dispose() {

		this.chainMaps = {};

	}

}

export default RenderContexts;
